name: ðŸ  Localhost Preview & Debug

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean
      test_only:
        description: 'Skip data generation, only test existing data'
        required: false
        default: 'false'
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_USERNAME: ${{ secrets.GITHUB_USERNAME }}

jobs:
  localhost-preview:
    name: ðŸ  Setup Local Environment
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ›’ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            apps/web/package-lock.json
            apps/api/github/package-lock.json
            e2e/package-lock.json

      - name: ðŸ“Š Generate Fresh Static Data
        if: inputs.test_only != 'true'
        run: |
          echo "ðŸ”„ Generating fresh GitHub data..."
          chmod +x ./.github/workflows/scripts/generate-static-data.sh
          ./.github/workflows/scripts/generate-static-data.sh

      - name: ðŸ“ Copy Static Data to Web App
        run: |
          echo "ðŸ“ Copying static data for single-server mode..."
          chmod +x ./.github/workflows/scripts/copy-static-data.sh
          ./.github/workflows/scripts/copy-static-data.sh

      - name: ðŸ”§ Build Web Application
        run: |
          echo "ðŸ”§ Building web application..."
          chmod +x ./.github/workflows/scripts/deploy-web.sh
          ./.github/workflows/scripts/deploy-web.sh

      - name: ðŸš€ Start Web Server (Background)
        run: |
          echo "ðŸš€ Starting web server on port 3023..."
          cd apps/web
          PORT=3023 npm start &
          echo "â° Waiting for server to start..."
          sleep 10

      - name: ðŸŒ Validate Web Server
        run: |
          echo "ðŸŒ Checking web server accessibility..."
          for i in {1..6}; do
            echo "Web server check $i/6..."
            if curl -f "http://localhost:3023" -m 10 > /dev/null 2>&1; then
              echo "âœ… Web server is running"
              break
            fi
            
            if [ $i -eq 6 ]; then
              echo "âŒ Web server failed to start"
              echo "ðŸ“‹ Server logs:"
              jobs
              exit 1
            fi
            
            sleep 5
          done

      - name: ðŸ“Š Test Static Data Endpoints
        run: |
          echo "ðŸ“Š Testing static data endpoints..."
          chmod +x ./.github/workflows/scripts/test-static-data.sh
          ./.github/workflows/scripts/test-static-data.sh http://localhost:3023

      - name: ðŸ§ª Run E2E Tests with Debug Logging
        run: |
          echo "ðŸ§ª Running E2E tests with enhanced logging..."
          
          # Enable debug mode if requested
          if [ "${{ inputs.debug_mode }}" = "true" ]; then
            echo "ðŸ” Debug mode enabled"
            export DEBUG=pw:api,pw:browser
          fi
          
          chmod +x ./.github/workflows/scripts/run-e2e-tests.sh
          ./.github/workflows/scripts/run-e2e-tests.sh http://localhost:3023

      - name: ðŸ§ª Run Additional E2E Tests for Loading Skeleton Debug
        run: |
          echo "ðŸ” Running specific E2E test to debug loading skeleton issue..."
          cd e2e
          WEB_URL=http://localhost:3023 npx playwright test tests/features/pull-request/single-server-quick-test.web.spec.ts --reporter=line --timeout=60000

      - name: ðŸ“¸ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: localhost-preview-artifacts
          path: |
            e2e/test-results/
            e2e/playwright-report/
            apps/web/static/pr-*.json
          retention-days: 7

      - name: ðŸŽ¯ Debug Information
        if: always()
        run: |
          echo "ðŸŽ¯ Debug Information:"
          echo "ðŸ“Š Generated static files:"
          ls -la apps/web/static/pr-*.json 2>/dev/null || echo "No static files found"
          
          echo "ðŸ“‹ Process status:"
          jobs || echo "No background jobs"
          
          echo "ðŸŒ Network test:"
          curl -I http://localhost:3023 2>/dev/null || echo "Server not accessible"
          
          echo "ðŸ“ Web app build status:"
          ls -la apps/web/build/ 2>/dev/null || echo "No build directory found"

      - name: ðŸ“‹ Summary
        if: always()
        run: |
          echo "## ðŸ  Localhost Preview Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Static Data" >> $GITHUB_STEP_SUMMARY
          if [ -f "apps/web/static/pr-metadata.json" ]; then
            file_count=$(ls apps/web/static/pr-*.json 2>/dev/null | wc -l)
            echo "âœ… Generated $file_count static files" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Static data generation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Build Status" >> $GITHUB_STEP_SUMMARY
          if [ -d "apps/web/build" ]; then
            echo "âœ… Web application built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Web application build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Instructions for Local Setup" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract static JSON files to \`apps/web/static/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`cd apps/web && PORT=3023 npm start\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Test at \`http://localhost:3023\`" >> $GITHUB_STEP_SUMMARY