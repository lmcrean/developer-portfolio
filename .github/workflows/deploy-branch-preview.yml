name: Deploy Branch Preview (Single-Server)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  deployments: write
  checks: write

jobs:
  deploy-web:
    uses: ./.github/workflows/deploy-web-branch.yml
    secrets: inherit
    with:
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}

  test-static:
    needs: deploy-web
    uses: ./.github/workflows/test-static.yml
    secrets: inherit
    with:
      web_url: ${{ needs.deploy-web.outputs.deployment_url }}

  test-e2e:
    needs: [deploy-web, test-static]
    if: needs.test-static.result == 'success'
    uses: ./.github/workflows/test-branch-e2e.yml
    secrets: inherit
    with:
      web_url: ${{ needs.deploy-web.outputs.deployment_url }}
      api_url: ${{ needs.deploy-web.outputs.deployment_url }}  # Same origin for fallback
      branch_name: ${{ github.head_ref }}
      pr_number: ${{ github.event.number }}

  update-pr:
    needs: [deploy-web, test-static, test-e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¬ Update PR with Deployment Status
        uses: actions/github-script@v7
        with:
          script: |
            const webUrl = '${{ needs.deploy-web.outputs.deployment_url }}';
            const staticTestStatus = '${{ needs.test-static.result }}';
            const e2eStatus = '${{ needs.test-e2e.result }}';
            const webStatus = '${{ needs.deploy-web.result }}';
            
            // Determine overall test status
            const allTestsPassed = staticTestStatus === 'success' && e2eStatus === 'success';
            const statusEmoji = allTestsPassed ? 'âœ…' : 'âš ï¸';
            const statusText = allTestsPassed ? 'All tests passed!' : 'Some tests failed';
            
            // Handle deployment failures
            let deploymentSection = '';
            if (webStatus === 'success') {
              deploymentSection = `## ğŸš€ SINGLE-SERVER DEPLOYMENT

            ### ğŸŒ Web App with Embedded Static Data
            **Live Preview:** [${webUrl}](${webUrl})

            ### ğŸ§ª Quick Test Links
            - [ğŸ“± Web App](${webUrl}) - Test the user interface
            - [ğŸ“Š Static Data](${webUrl}/pr-metadata.json) - Verify static data serving
            - [ğŸ”— Click here to test!](${webUrl})

            ### âš¡ Performance Features
            - **Sub-second loading** with embedded static data
            - **No API server dependency** - single-server architecture
            - **Same-origin requests** for optimal performance
            - **Automatic fallback** to live GitHub API if needed

            ### ğŸ§ª Test Results
            - **Static Data Tests**: ${staticTestStatus === 'success' ? 'âœ… Passed' : staticTestStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            - **E2E Tests**: ${e2eStatus === 'success' ? 'âœ… Passed' : e2eStatus === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
            
            ${statusEmoji} ${statusText}`;
            } else {
              deploymentSection = `## âŒ DEPLOYMENT FAILED

            ### Deployment Status
            - **Web**: ${webStatus === 'success' ? 'âœ…' : 'âŒ'} ${webStatus === 'success' ? webUrl : 'Deployment failed'}
            
            ${webStatus !== 'success' ? `**Web Error:** ${webUrl || 'Web deployment failed - check logs'}` : ''}`;
            }

            const commentBody = `${deploymentSection}

            ---
            *ğŸ”„ Last updated: ${new Date().toLocaleString()} UTC*
            
            <!-- BRANCH_DEPLOYMENT_COMMENT -->`;

            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment => 
              comment.body.includes('<!-- BRANCH_DEPLOYMENT_COMMENT -->')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } 